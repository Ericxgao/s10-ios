machine:
  xcode:
    version: "6.3.1"
  environment:
    XCODE_WORKSPACE: S10.xcworkspace
    XCODE_SCHEME: BackendTests
    CRASHLYTICS_API_KEY: c1afe3ecfc536b752df1c1789daab85a27e52bb1
    CRASHLYTICS_BUILD_SECRET: f7e9d0747d41785ed3db08b8c0772dc6acd4093a6c24f43aee01f2467cd221f8
    CRASHLYTICS_FRAMEWORK_PATH: Pods/CrashlyticsFramework/Crashlytics.framework

dependencies:
  override:
  pre:
    - brew update
    - brew upgrade xctool
    - sudo gem uninstall highline commander --ignore-dependencies -x
    - sudo gem install cocoapods -v $(var=$(tail -1 Podfile.lock); echo ${var##COCOAPODS:})
    - sudo gem install cupertino shenzhen sigh
    - ./scripts/import_credentials.sh
  override:
    - pod update Meteor
  cache_directories:
    - "Pods"

test:
  post:
    - ? |
        source ./scripts/circle_env.sh
        ipa build --scheme Taylr \
                  --xcconfig Configs/${XCCONFIG_NAME}.xcconfig \
                  --xcargs BUNDLE_BUILD=$BN \
                  --no-clean --verbose -t | tee $CIRCLE_ARTIFACTS/build.log
        mv Taylr.ipa $CIRCLE_ARTIFACTS/${BN}.ipa
        mv Taylr.app.dSYM.zip $CIRCLE_ARTIFACTS/${BN}.app.dSYM.zip
        ./scripts/circle_release_notes.sh >> $CIRCLE_ARTIFACTS/release_notes.txt
      : timeout: 1200
    - zip -FSr $CIRCLE_ARTIFACTS/Pods.zip Pods/

#deployment:
#  Taylr Dev:
#    branch: master
#    commands:
#      - |
#        source ./scripts/circle_env.sh
#        ./scripts/deploy_crashlytics.sh
#        cd scripts
#        brew install node
#        npm install
#        node deploy_dev.js
#
#  Taylr Beta:
#    branch: beta
#    commands:
#      - |
#        source ./scripts/circle_env.sh
#        ./scripts/deploy_crashlytics.sh
#        cd scripts
#        brew install node
#        npm install
#        node deploy_beta.js
#
#  Taylr:
#    branch: prod
#    commands:
#      - |
#        source ./scripts/circle_env.sh
#        ./scripts/deploy_crashlytics.sh
#        cd $CIRCLE_ARTIFACTS
#        cp "${BN}.ipa" "${BN}_appstore.ipa"
#        sigh resign "${BN}_appstore.ipa" \
#          --provisioning_profile "$HOME/Library/MobileDevice/Provisioning Profiles/commilasyaketchappstore.mobileprovision" \
#          --signing_identity "iPhone Distribution: Milasya Inc."
