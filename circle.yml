machine:
  xcode:
    version: "7.1"

dependencies:
  override:
  pre:
    - brew update
    - brew install node
    - npm install -g npm@2.14.13 # npm 3 sucks
    - sudo gem update fastlane gym
    - sudo gem install cocoapods -v $(var=$(tail -1 ios/Podfile.lock); echo ${var##COCOAPODS:})
  override:
    - npm install
    - npm install -g react-native-cli # Technically should use the one installed above, but temp workaround
    - fastlane pod_install
  post:
    - fastlane import_certs
  cache_directories:
    - "node_modules"
    - "ios/Pods"

test:
  override:
    - fastlane circle_archive

deployment:
  master:
    branch: master
    commands:
      - fastlane upload_crashlytics
      - fastlane upload_apphub target:none

  prod:
    branch: prod
    commands:
      # TODO: Also upload to crashlytics would be nice, also auto-release to beta would be nice too
      - fastlane upload_itunesconnect
      # This will distribute to TestFlight users, in order to distribute to appstore
      # Manully visit https://dashboard.apphub.io/projects/uCG85kfu67WewOZVEQBk/ and change target
      - fastlane upload_apphub target:debug

  # TODO: Create appstore branch, upload to Crashlytics + beta + apphub target:all + deliver & submit to store