machine:
  xcode:
    version: "7.1"

dependencies:
  override:
  pre:
    - brew update
    - brew install node
    - npm install -g npm@2.14.13 # npm 3 sucks
    - sudo gem update fastlane gym
    - sudo gem install cocoapods -v $(var=$(tail -1 ios/Podfile.lock); echo ${var##COCOAPODS:})
  override:
    - npm install
    - npm install -g react-native-cli # Technically should use the one installed above, but temp workaround
    - fastlane pod_install
  post:
    - fastlane import_certs
  cache_directories:
    - "node_modules"
    - "ios/Pods"

test:
  override:
    - fastlane circle_archive

deployment:
  master:
    branch: master
    commands:
      - fastlane upload_crashlytics

  prod:
    branch: prod
    commands:
      - fastlane upload_itunesconnect
