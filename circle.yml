machine:
  environment:
    CRASHLYTICS_API_KEY: 4cdb005d0ddfebc8865c0a768de9b43c993e9113
    CRASHLYTICS_BUILD_SECRET: 83001519164842a323e4d70c5970b041c248835fec59db59b409f5b364e47f72
    CRASHLYTICS_FRAMEWORK_PATH: Pods/CrashlyticsFramework/Crashlytics.framework
    APPLE_ID: tony@ketchy.co

dependencies:
  pre:
    - sudo gem install cocoapods -v 0.36.0.beta.2
    - sudo gem install shenzhen cupertino xcpretty
    - ./scripts/import_credentials.sh
  cache_directories:
    - "Pods"

test:
  override:
    - xcodebuild -workspace Ketch.xcworkspace -scheme Ketch -sdk iphonesimulator test | xcpretty -c
  post:
    - ? |
        source ./scripts/env.sh
        ipa build -t --xcconfig Configs/${XCCONFIG_NAME}.xcconfig \
                     --xcargs BUNDLE_BUILD=$BN \
                     --no-clean
        mv Ketch.ipa $CIRCLE_ARTIFACTS/${BN}.ipa
        mv Ketch.app.dSYM.zip $CIRCLE_ARTIFACTS/${BN}.app.dSYM.zip
      : timeout: 900

deployment:
  Ketch Dev:
    branch: master
    commands:
      - |
        source ./scripts/env.sh
        ./scripts/release_notes.sh >> release_notes.txt
        "$CRASHLYTICS_FRAMEWORK_PATH/submit" $CRASHLYTICS_API_KEY $CRASHLYTICS_BUILD_SECRET \
                                            -ipaPath $CIRCLE_ARTIFACTS/${BN}.ipa \
                                            -groupAliases team \
                                            -notifications NO \
                                            -notesPath release_notes.txt
